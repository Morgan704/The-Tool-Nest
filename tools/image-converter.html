<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Image Converter — Nest</title>
  <link rel="stylesheet" href="../assets/styles.css">
  <style>
    body { font-family: Arial, sans-serif; background:#f9f9f9; margin:0; padding:0; }
    .tool-container { max-width: 800px; margin: 60px auto; padding: 30px; background:#fff; border-radius: 12px; box-shadow:0 6px 20px rgba(0,0,0,0.1); }
    h1 { margin-top:0; }
    .upload-box { border:2px dashed #aaa; padding:30px; text-align:center; border-radius:8px; cursor:pointer; background:#fafafa; transition:0.2s; }
    .upload-box.dragover { border-color:#007bff; background:#eef6ff; }
    .controls { display:flex; gap:12px; margin-top:20px; flex-wrap:wrap; }
    .controls label { font-weight:bold; }
    .preview { margin-top:20px; text-align:center; }
    .preview img { max-width:320px; border-radius:8px; margin-bottom:10px; }
    .info { font-size:14px; color:#555; }
    .btn { padding:10px 18px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; }
    .btn-primary { background:#007bff; color:#fff; }
    .btn-secondary { background:#ddd; color:#000; }
    .btn:disabled { opacity:0.6; cursor:not-allowed; }
  </style>
</head>
<body>

<div class="tool-container">
  <a href="../index.html">← Home</a>
  <h1>Image Converter & Resizer</h1>
  <p>Upload an image (or drag & drop), choose output format and size, then download instantly.</p>

  <div id="uploadBox" class="upload-box">
    <p>Click or Drag & Drop an image here</p>
    <input type="file" id="fileInput" accept="image/*" hidden>
  </div>

  <div class="controls">
    <label>Format:
      <select id="format">
        <option value="image/webp">WebP</option>
        <option value="image/png">PNG</option>
        <option value="image/jpeg">JPG</option>
      </select>
    </label>

    <label>Max size:
      <select id="size">
        <option value="0">Original</option>
        <option value="1080">1080px</option>
        <option value="720">720px</option>
        <option value="480">480px</option>
      </select>
    </label>

    <button id="convert" class="btn btn-primary">Convert</button>
    <button id="reset" class="btn btn-secondary">Reset</button>
  </div>

  <div id="preview" class="preview"></div>
  <div style="text-align:center;">
    <button id="download" class="btn btn-primary" disabled>Download</button>
  </div>
</div>

<script>
const uploadBox = document.getElementById('uploadBox');
const fileInput = document.getElementById('fileInput');
const formatSel = document.getElementById('format');
const sizeSel = document.getElementById('size');
const convertBtn = document.getElementById('convert');
const resetBtn = document.getElementById('reset');
const preview = document.getElementById('preview');
const dlBtn = document.getElementById('download');

let currentFile = null, blobUrl = '';

// Drag & drop
uploadBox.addEventListener('click', ()=> fileInput.click());
uploadBox.addEventListener('dragover', e => { e.preventDefault(); uploadBox.classList.add('dragover'); });
uploadBox.addEventListener('dragleave', ()=> uploadBox.classList.remove('dragover'));
uploadBox.addEventListener('drop', e => {
  e.preventDefault(); uploadBox.classList.remove('dragover');
  fileInput.files = e.dataTransfer.files;
  currentFile = fileInput.files[0];
});

// On file input
fileInput.addEventListener('change', ()=> currentFile = fileInput.files[0]);

resetBtn.addEventListener('click', ()=>{
  fileInput.value=''; currentFile=null; preview.innerHTML=''; dlBtn.disabled=true;
  if(blobUrl) { URL.revokeObjectURL(blobUrl); blobUrl=''; }
});

// Convert
convertBtn.addEventListener('click', async ()=>{
  if(!currentFile){ alert('Please select an image'); return; }
  const img = new Image();
  const url = URL.createObjectURL(currentFile);
  img.src = url; await img.decode();

  let w = img.width, h = img.height;
  const maxSide = parseInt(sizeSel.value,10);
  if(maxSide>0 && Math.max(w,h) > maxSide){
    if(w >= h){ h = Math.round(h * (maxSide/w)); w=maxSide; }
    else { w = Math.round(w * (maxSide/h)); h=maxSide; }
  }

  const canvas = document.createElement('canvas');
  canvas.width=w; canvas.height=h;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(img,0,0,w,h);

  const mime = formatSel.value;
  canvas.toBlob(b=>{
    if(!b){ alert('Conversion failed'); return; }
    if(blobUrl) URL.revokeObjectURL(blobUrl);
    blobUrl = URL.createObjectURL(b);

    const fileSizeKB = (b.size/1024).toFixed(1);
    const ext = mime==='image/jpeg'?'JPG': mime.split('/')[1].toUpperCase();

    preview.innerHTML = `
      <img src="${blobUrl}" alt="preview">
      <div class="info">Converted to: <strong>${ext}</strong> — ${w}×${h}px — ${fileSizeKB} KB</div>
    `;

    dlBtn.disabled=false;
    dlBtn.onclick=()=>{
      const a=document.createElement('a');
      a.href=blobUrl;
      a.download='converted.'+ext.toLowerCase();
      a.click();
    };

    URL.revokeObjectURL(url);
  }, mime, 0.92);
});
</script>

</body>
</html>
